<div class="container mt-5 pb-5">
  <div class="card shadow-sm border-0 mb-4" *ngIf="authService.getStoredRol() == '1'">
    <div class="card-header bg-white py-3 border-bottom">
      <h3 class="m-0 text-primary fw-bold">
        <i class="bi bi-people-fill me-2"></i>Seleccione un Cliente
      </h3>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-4">IDENTIFICACIÓN</th>
              <th>NOMBRE COMPLETO</th>
              <th class="text-center">ACCIÓN</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cliente of clientes"
                (click)="seleccionarCliente(cliente)"
                [class.table-primary]="clienteSeleccionado?.idCliente === cliente.idCliente"
                style="cursor: pointer;">
              <td class="ps-4">{{ cliente.numeroIdentificacion }}</td>
              <td class="fw-bold">{{ cliente.nombre }} {{ cliente.apellidoPaterno }} {{ cliente.apellidoMaterno }}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-primary">Ver Pólizas</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div *ngIf="clienteSeleccionado" class="animate__animated animate__fadeIn">
    <div class="card shadow border-0 bg-light">
      <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
        <h4 class="m-0">Pólizas {{ clienteSeleccionado.nombre }}</h4>
        <button *ngIf="authService.getStoredRol() === '1'"
                class="btn btn-light btn-sm fw-bold"
                [routerLink]="['/poliza/form', clienteSeleccionado.idCliente]">
          Nueva Póliza
        </button>
      </div>

      <div class="card-body bg-white border-bottom">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label small fw-bold">Tipo</label>
            <select class="form-select form-select-sm" [(ngModel)]="filtros.tipo" (change)="filtrarPolizas()">
              <option value="">Todos los tipos</option>
              <option value="Vida">Vida</option>
              <option value="Autos">Autos</option>
              <option value="Gastos Médicos">Gastos Médicos</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small fw-bold">Estado</label>
            <select class="form-select form-select-sm" [(ngModel)]="filtros.estado" (change)="filtrarPolizas()">
              <option value="Todas">Todos los estados</option>
              <option value="Activa">Activa</option>
              <option value="Inactiva">Inactiva</option>
            </select>
          </div>
          <div class="col-md-5">
            <label class="form-label small fw-bold">Rango de Fecha (Inicio)</label>
            <div class="input-group input-group-sm">
              <input type="date" class="form-control" [(ngModel)]="filtros.fechaInicio" (change)="filtrarPolizas()">
              <input type="date" class="form-control" [(ngModel)]="filtros.fechaFin" (change)="filtrarPolizas()">
            </div>
          </div>
        </div>
      </div>

      <div class="card-body p-0 bg-white">
        <div *ngIf="loadingPolizas" class="text-center py-4">
          <div class="spinner-border text-primary"></div>
        </div>

        <div class="table-responsive" *ngIf="!loadingPolizas">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-secondary text-uppercase small">
              <tr>
                <th class="ps-4">Tipo</th>
                <th>Monto</th>
                <th>Vigencia</th>
                <th>Estado</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let poliza of polizas">
                <td class="ps-4 fw-bold">{{ poliza.nombreTipoPoliza }}</td>
                <td class="text-success fw-bold">{{ poliza.montoAsegurado | currency }}</td>
                <td>{{ poliza.fechaInicio | date:'dd/MM/yyyy' }} - {{ poliza.fechaFin | date:'dd/MM/yyyy' }}</td>
                <td>
                  <span class="badge" [ngClass]="poliza.estado === 'Activa' ? 'bg-success' : 'bg-danger'">
                    {{ poliza.estado }}
                  </span>
                </td>
                <td class="text-center">
                  <ng-container *ngIf="authService.getStoredRol() === '1'">
                    <button class="btn btn-outline-warning btn-sm me-2" [routerLink]="['/poliza/form', clienteSeleccionado.idCliente, poliza.idPoliza]">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" (click)="eliminarPoliza(poliza.idPoliza)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </ng-container>

                  <button *ngIf="authService.getStoredRol() === '2' && poliza.estado === 'Activa'"
                          class="btn btn-danger btn-sm"
                          (click)="solicitarCancelacion(poliza.idPoliza)">
                    Solicitar Cancelación
                  </button>
                </td>
              </tr>
              <tr *ngIf="polizas.length === 0">
                <td colspan="5" class="text-center py-4 text-muted">No hay pólizas con estos filtros.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
